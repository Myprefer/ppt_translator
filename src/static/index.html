<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPTç¿»è¯‘è½¯ä»¶</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .upload-section {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-section:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .upload-section.dragover {
            border-color: #667eea;
            background-color: #f0f4ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #666;
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        select, input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: #fff;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .translate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .translate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .translate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-section {
            display: none;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e1e5e9;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 6px;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                transparent 25%, 
                rgba(255,255,255,0.2) 25%, 
                rgba(255,255,255,0.2) 50%, 
                transparent 50%, 
                transparent 75%, 
                rgba(255,255,255,0.2) 75%);
            background-size: 20px 20px;
            animation: progressStripes 1s linear infinite;
        }

        @keyframes progressStripes {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }

        .progress-text {
            text-align: center;
            color: #555;
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #666;
            font-size: 0.9rem;
        }

        .progress-percentage {
            font-weight: 600;
            color: #667eea;
        }

        .result-section {
            display: none;
            text-align: center;
        }

        .success-icon {
            font-size: 3rem;
            color: #4caf50;
            margin-bottom: 20px;
        }

        .download-btn {
            padding: 12px 30px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .download-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .file-info {
            display: none;
            background: #f8f9ff;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .file-info h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .file-info p {
            color: #666;
            font-size: 0.9rem;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .local-files-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
        }

        .local-files-section h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .local-files-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .file-info-local {
            flex: 1;
        }

        .file-info-local h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 0.9rem;
        }

        .file-info-local p {
            margin: 0;
            color: #666;
            font-size: 0.8rem;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .file-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .download-local-btn {
            background: #4caf50;
            color: white;
        }

        .download-local-btn:hover {
            background: #45a049;
        }

        .delete-local-btn {
            background: #f44336;
            color: white;
        }

        .delete-local-btn:hover {
            background: #da190b;
        }

        .no-files-message {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .model-info {
            margin-top: 8px;
            padding: 10px;
            background: #f8f9ff;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .model-info small {
            color: #666;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .model-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
            vertical-align: middle;
        }

        .cost-low {
            background: #4caf50;
            color: white;
        }

        .cost-medium {
            background: #ff9800;
            color: white;
        }

        .cost-high {
            background: #f44336;
            color: white;
        }

        .model-help-link {
            color: #667eea;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 5px;
            text-decoration: underline;
        }

        .model-help-link:hover {
            color: #5a67d8;
        }

        .model-help-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .model-help-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .model-help-close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .model-help-close:hover {
            color: #333;
        }

        .model-comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .model-comparison-table th,
        .model-comparison-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .model-comparison-table th {
            background-color: #f8f9ff;
            font-weight: 600;
        }

        .model-comparison-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ PPTç¿»è¯‘è½¯ä»¶</h1>
            <p>åŸºäºAIçš„æ™ºèƒ½PPTæ–‡æ¡£ç¿»è¯‘å·¥å…·ï¼Œä¿æŒåŸæœ‰æ ¼å¼çš„åŒæ—¶æä¾›é«˜è´¨é‡ç¿»è¯‘</p>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-icon">ğŸ“„</div>
            <div class="upload-text">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½PPTæ–‡ä»¶åˆ°æ­¤å¤„</div>
            <div class="upload-subtext">æ”¯æŒ .pptx æ ¼å¼æ–‡ä»¶ï¼Œæœ€å¤§50MB</div>
            <input type="file" id="fileInput" class="file-input" accept=".pptx" />
        </div>

        <div class="file-info" id="fileInfo">
            <h4 id="fileName"></h4>
            <p id="fileSize"></p>
        </div>

        <div class="form-group">
            <div class="form-row">
                <div>
                    <label for="sourceLanguage">æºè¯­è¨€</label>
                    <select id="sourceLanguage">
                        <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="en">è‹±è¯­</option>
                        <option value="ja">æ—¥è¯­</option>
                        <option value="ko">éŸ©è¯­</option>
                        <option value="fr">æ³•è¯­</option>
                        <option value="de">å¾·è¯­</option>
                        <option value="es">è¥¿ç­ç‰™è¯­</option>
                        <option value="ru">ä¿„è¯­</option>
                    </select>
                </div>
                <div>
                    <label for="targetLanguage">ç›®æ ‡è¯­è¨€</label>
                    <select id="targetLanguage">
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="en">è‹±è¯­</option>
                        <option value="ja">æ—¥è¯­</option>
                        <option value="ko">éŸ©è¯­</option>
                        <option value="fr">æ³•è¯­</option>
                        <option value="de">å¾·è¯­</option>
                        <option value="es">è¥¿ç­ç‰™è¯­</option>
                        <option value="ru">ä¿„è¯­</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="apiKey">Qwen APIå¯†é’¥</label>
            <input type="text" id="apiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„Qwen APIå¯†é’¥" />
        </div>

        <div class="form-group">
            <label for="modelSelect">
                ç¿»è¯‘æ¨¡å‹
                <span class="model-help-link" onclick="showModelHelp()">(?)</span>
            </label>
            <select id="modelSelect">
                <option value="">åŠ è½½ä¸­...</option>
            </select>
            <div class="model-info" id="modelInfo">
                <small id="modelDescription">é€‰æ‹©ä¸€ä¸ªæ¨¡å‹æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</small>
            </div>
        </div>

        <button class="translate-btn" id="translateBtn" onclick="startTranslation()">
            å¼€å§‹ç¿»è¯‘
        </button>

        <div class="progress-section" id="progressSection">
            <div class="progress-text" id="progressText">æ­£åœ¨å¤„ç†ä¸­...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-details">
                <span id="progressSlideInfo">å‡†å¤‡ä¸­...</span>
                <span class="progress-percentage" id="progressPercentage">0%</span>
            </div>
        </div>

        <div class="result-section" id="resultSection">
            <div class="success-icon">âœ…</div>
            <h3>ç¿»è¯‘å®Œæˆï¼</h3>
            <p>æ‚¨çš„PPTæ–‡ä»¶å·²æˆåŠŸç¿»è¯‘å®Œæˆå¹¶ä¿å­˜åˆ°æœ¬åœ°</p>
            <br>
            <a href="#" class="download-btn" id="downloadBtn">ä¸‹è½½ç¿»è¯‘åçš„æ–‡ä»¶</a>
            <button class="download-btn" onclick="showLocalFiles()" style="margin-left: 10px; background: #2196F3;">æŸ¥çœ‹æœ¬åœ°æ–‡ä»¶</button>
        </div>

        <div class="local-files-section" id="localFilesSection" style="display: none;">
            <h3>æœ¬åœ°ä¿å­˜çš„ç¿»è¯‘æ–‡ä»¶</h3>
            <div class="local-files-list" id="localFilesList">
                <!-- æ–‡ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
            <button class="download-btn" onclick="hideLocalFiles()" style="background: #666; margin-top: 20px;">å…³é—­</button>
        </div>

        <!-- æ¨¡å‹å¸®åŠ©å¼¹çª— -->
        <div class="model-help-modal" id="modelHelpModal">
            <div class="model-help-content">
                <span class="model-help-close" onclick="hideModelHelp()">&times;</span>
                <h2>ç¿»è¯‘æ¨¡å‹é€‰æ‹©æŒ‡å—</h2>
                <p>ä¸åŒçš„ç¿»è¯‘æ¨¡å‹æœ‰ä¸åŒçš„ç‰¹ç‚¹å’Œé€‚ç”¨åœºæ™¯ï¼Œè¯·æ ¹æ®æ‚¨çš„éœ€æ±‚é€‰æ‹©ï¼š</p>
                
                <table class="model-comparison-table">
                    <thead>
                        <tr>
                            <th>æ¨¡å‹</th>
                            <th>é€Ÿåº¦</th>
                            <th>è´¨é‡</th>
                            <th>æˆæœ¬</th>
                            <th>æœ€å¤§ä»¤ç‰Œ</th>
                            <th>æ¨èåœºæ™¯</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Qwen-Turbo</strong></td>
                            <td>âš¡âš¡âš¡</td>
                            <td>â­â­</td>
                            <td>ğŸ’°</td>
                            <td>4,000</td>
                            <td>å¤§é‡æ–‡æœ¬ã€å¿«é€Ÿç¿»è¯‘ã€æˆæœ¬æ•æ„Ÿ</td>
                        </tr>
                        <tr>
                            <td><strong>Qwen-Plus</strong></td>
                            <td>âš¡âš¡</td>
                            <td>â­â­â­</td>
                            <td>ğŸ’°ğŸ’°</td>
                            <td>8,000</td>
                            <td>å¹³è¡¡æ€§èƒ½ä¸æˆæœ¬ï¼Œæ—¥å¸¸ä½¿ç”¨</td>
                        </tr>
                        <tr>
                            <td><strong>Qwen-Max</strong></td>
                            <td>âš¡</td>
                            <td>â­â­â­â­</td>
                            <td>ğŸ’°ğŸ’°ğŸ’°</td>
                            <td>16,000</td>
                            <td>é«˜è´¨é‡ç¿»è¯‘ã€ä¸“ä¸šæ–‡æ¡£</td>
                        </tr>
                        <tr>
                            <td><strong>Qwen-Max-LongContext</strong></td>
                            <td>âš¡</td>
                            <td>â­â­â­â­</td>
                            <td>ğŸ’°ğŸ’°ğŸ’°</td>
                            <td>32,000</td>
                            <td>è¶…é•¿æ–‡æ¡£ã€å¤æ‚ä¸Šä¸‹æ–‡</td>
                        </tr>
                    </tbody>
                </table>

                <h3>é€‰æ‹©å»ºè®®</h3>
                <ul>
                    <li><strong>æ–°æ‰‹ç”¨æˆ·</strong>: æ¨è Qwen-Plusï¼Œå¹³è¡¡æ€§èƒ½ä¸æˆæœ¬</li>
                    <li><strong>å¤§é‡ç¿»è¯‘</strong>: æ¨è Qwen-Turboï¼Œæˆæœ¬ä½é€Ÿåº¦å¿«</li>
                    <li><strong>ä¸“ä¸šç¿»è¯‘</strong>: æ¨è Qwen-Maxï¼Œè´¨é‡æœ€é«˜</li>
                    <li><strong>è¶…é•¿æ–‡æ¡£</strong>: æ¨è Qwen-Max-LongContextï¼Œæ”¯æŒé•¿ä¸Šä¸‹æ–‡</li>
                </ul>

                <h3>æ³¨æ„äº‹é¡¹</h3>
                <ul>
                    <li>æ¨¡å‹è´¨é‡è¶Šé«˜ï¼Œç¿»è¯‘æ—¶é—´å¯èƒ½è¶Šé•¿</li>
                    <li>é«˜è´¨é‡æ¨¡å‹çš„APIè°ƒç”¨æˆæœ¬æ›´é«˜</li>
                    <li>é€‰æ‹©åˆé€‚çš„æ¨¡å‹å¯ä»¥åœ¨è´¨é‡å’Œæˆæœ¬ä¹‹é—´æ‰¾åˆ°å¹³è¡¡</li>
                    <li>å¯ä»¥å…ˆç”¨ä½æˆæœ¬æ¨¡å‹æµ‹è¯•ï¼Œæ»¡æ„åå†ç”¨é«˜è´¨é‡æ¨¡å‹</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;

        // æ–‡ä»¶ä¸Šä¼ ç›¸å…³
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');

        uploadSection.addEventListener('click', () => fileInput.click());
        uploadSection.addEventListener('dragover', handleDragOver);
        uploadSection.addEventListener('dragleave', handleDragLeave);
        uploadSection.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        function handleDragOver(e) {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.pptx')) {
                showError('è¯·é€‰æ‹©.pptxæ ¼å¼çš„æ–‡ä»¶');
                return;
            }

            if (file.size > 50 * 1024 * 1024) { // 50MB
                showError('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡50MB');
                return;
            }

            selectedFile = file;
            fileName.textContent = file.name;
            fileSize.textContent = `æ–‡ä»¶å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            fileInfo.style.display = 'block';
            hideError();
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function updateProgress(percent, text, currentSlide, totalSlides) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressSlideInfo = document.getElementById('progressSlideInfo');
            const progressPercentage = document.getElementById('progressPercentage');
            
            // æ›´æ–°è¿›åº¦æ¡
            progressFill.style.width = Math.round(percent) + '%';
            
            // æ›´æ–°ä¸»è¦çŠ¶æ€æ–‡æœ¬
            progressText.textContent = text;
            
            // æ›´æ–°ç™¾åˆ†æ¯”
            progressPercentage.textContent = Math.round(percent) + '%';
            
            // æ›´æ–°å¹»ç¯ç‰‡ä¿¡æ¯
            if (currentSlide !== undefined && totalSlides !== undefined && totalSlides > 0) {
                progressSlideInfo.textContent = `ç¬¬ ${currentSlide} é¡µ / å…± ${totalSlides} é¡µ`;
            } else {
                progressSlideInfo.textContent = 'å‡†å¤‡ä¸­...';
            }
        }

        async function startTranslation() {
            if (!selectedFile) {
                showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªPPTæ–‡ä»¶');
                return;
            }

            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showError('è¯·è¾“å…¥Qwen APIå¯†é’¥');
                return;
            }

            const sourceLanguage = document.getElementById('sourceLanguage').value;
            const targetLanguage = document.getElementById('targetLanguage').value;
            const selectedModel = document.getElementById('modelSelect').value;

            if (sourceLanguage === targetLanguage && sourceLanguage !== 'auto') {
                showError('æºè¯­è¨€å’Œç›®æ ‡è¯­è¨€ä¸èƒ½ç›¸åŒ');
                return;
            }

            if (!selectedModel) {
                showError('è¯·é€‰æ‹©ç¿»è¯‘æ¨¡å‹');
                return;
            }

            hideError();

            // æ˜¾ç¤ºè¿›åº¦æ¡
            document.getElementById('translateBtn').disabled = true;
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';

            try {
                // åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('source_language', sourceLanguage);
                formData.append('target_language', targetLanguage);
                formData.append('api_key', apiKey);
                formData.append('model', selectedModel);

                updateProgress(5, `æ­£åœ¨ä¸Šä¼ æ–‡ä»¶... ä½¿ç”¨æ¨¡å‹: ${availableModels[selectedModel]?.name || selectedModel}`);

                // å‘é€è¯·æ±‚åˆ°åç«¯
                const response = await fetch('/api/translate', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'ç¿»è¯‘å¤±è´¥');
                }

                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.message);
                }

                // å¼€å§‹ç›‘å¬è¿›åº¦æ›´æ–°
                const taskId = result.task_id;
                const eventSource = new EventSource(`/api/progress/${taskId}`);
                
                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.error) {
                            eventSource.close();
                            showError(data.message);
                            document.getElementById('progressSection').style.display = 'none';
                            return;
                        }
                        
                        updateProgress(
                            data.progress, 
                            data.status, 
                            data.current_slide, 
                            data.total_slides
                        );
                        
                        if (data.completed) {
                            eventSource.close();
                            
                            // æ˜¾ç¤ºç»“æœ
                            document.getElementById('progressSection').style.display = 'none';
                            document.getElementById('resultSection').style.display = 'block';
                            document.getElementById('downloadBtn').href = data.download_url;
                        }
                    } catch (e) {
                        console.error('è§£æè¿›åº¦æ•°æ®æ—¶å‡ºé”™:', e);
                    }
                };
                
                eventSource.onerror = function(event) {
                    eventSource.close();
                    showError('è¿æ¥æœåŠ¡å™¨å‡ºé”™ï¼Œè¯·é‡è¯•');
                    document.getElementById('progressSection').style.display = 'none';
                };

            } catch (error) {
                showError('ç¿»è¯‘è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ' + error.message);
                document.getElementById('progressSection').style.display = 'none';
            } finally {
                document.getElementById('translateBtn').disabled = false;
            }
        }

        // æœ¬åœ°æ–‡ä»¶ç®¡ç†å‡½æ•°
        async function showLocalFiles() {
            try {
                const response = await fetch('/api/local-files');
                const result = await response.json();
                
                if (result.error) {
                    showError('è·å–æœ¬åœ°æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + result.message);
                    return;
                }
                
                const localFilesSection = document.getElementById('localFilesSection');
                const localFilesList = document.getElementById('localFilesList');
                
                if (result.files.length === 0) {
                    localFilesList.innerHTML = '<div class="no-files-message">æš‚æ— æœ¬åœ°ä¿å­˜çš„æ–‡ä»¶</div>';
                } else {
                    localFilesList.innerHTML = result.files.map(file => `
                        <div class="file-item">
                            <div class="file-info-local">
                                <h4>${file.filename}</h4>
                                <p>å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB | åˆ›å»ºæ—¶é—´: ${file.created_time}</p>
                            </div>
                            <div class="file-actions">
                                <button class="download-local-btn" onclick="downloadLocalFile('${file.filename}')">ä¸‹è½½</button>
                                <button class="delete-local-btn" onclick="deleteLocalFile('${file.filename}')">åˆ é™¤</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                localFilesSection.style.display = 'block';
                
            } catch (error) {
                showError('è·å–æœ¬åœ°æ–‡ä»¶åˆ—è¡¨æ—¶å‡ºé”™: ' + error.message);
            }
        }

        function hideLocalFiles() {
            document.getElementById('localFilesSection').style.display = 'none';
        }

        async function downloadLocalFile(filename) {
            try {
                window.open(`/api/download-local/${filename}`, '_blank');
            } catch (error) {
                showError('ä¸‹è½½æ–‡ä»¶æ—¶å‡ºé”™: ' + error.message);
            }
        }

        async function deleteLocalFile(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/delete-local/${filename}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.error) {
                    showError('åˆ é™¤æ–‡ä»¶å¤±è´¥: ' + result.message);
                    return;
                }
                
                // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                showLocalFiles();
                
            } catch (error) {
                showError('åˆ é™¤æ–‡ä»¶æ—¶å‡ºé”™: ' + error.message);
            }
        }

        // æ¨¡å‹ç›¸å…³å˜é‡
        let availableModels = {};

        // é¡µé¢åŠ è½½æ—¶åŠ è½½æ¨¡å‹åˆ—è¡¨
        async function loadModels() {
            try {
                const response = await fetch('/api/models');
                const result = await response.json();
                
                if (result.error) {
                    console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', result.message);
                    document.getElementById('modelSelect').innerHTML = '<option value="qwen-turbo">Qwen-Turbo (é»˜è®¤)</option>';
                    return;
                }
                
                availableModels = result.models;
                const modelSelect = document.getElementById('modelSelect');
                
                // æ¸…ç©ºé€‰é¡¹
                modelSelect.innerHTML = '';
                
                // æ·»åŠ æ¨¡å‹é€‰é¡¹
                Object.keys(availableModels).forEach(modelKey => {
                    const model = availableModels[modelKey];
                    const option = document.createElement('option');
                    option.value = modelKey;
                    option.textContent = `${model.name} - ${model.description}`;
                    if (modelKey === 'qwen-turbo') {
                        option.selected = true; // é»˜è®¤é€‰æ‹©qwen-turbo
                    }
                    modelSelect.appendChild(option);
                });
                
                // æ˜¾ç¤ºé»˜è®¤æ¨¡å‹ä¿¡æ¯
                updateModelInfo('qwen-turbo');
                
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹æ—¶å‡ºé”™:', error);
                document.getElementById('modelSelect').innerHTML = '<option value="qwen-turbo">Qwen-Turbo (é»˜è®¤)</option>';
            }
        }

        // æ›´æ–°æ¨¡å‹ä¿¡æ¯æ˜¾ç¤º
        function updateModelInfo(modelKey) {
            const modelInfo = document.getElementById('modelInfo');
            const modelDescription = document.getElementById('modelDescription');
            
            if (availableModels[modelKey]) {
                const model = availableModels[modelKey];
                const costClass = model.cost === 'ä½' ? 'cost-low' : 
                                model.cost === 'ä¸­' ? 'cost-medium' : 'cost-high';
                
                modelDescription.innerHTML = `
                    <strong>${model.name}</strong>
                    <span class="model-badge ${costClass}">æˆæœ¬: ${model.cost}</span>
                    <br>
                    ${model.description}
                    <br>
                    æœ€å¤§ä»¤ç‰Œæ•°: ${model.max_tokens.toLocaleString()}
                `;
                modelInfo.style.display = 'block';
            } else {
                modelDescription.textContent = 'é€‰æ‹©ä¸€ä¸ªæ¨¡å‹æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯';
                modelInfo.style.display = 'none';
            }
        }

        // ç›‘å¬æ¨¡å‹é€‰æ‹©å˜åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadModels();
            
            const modelSelect = document.getElementById('modelSelect');
            modelSelect.addEventListener('change', function() {
                updateModelInfo(this.value);
            });
        });

        // é¡µé¢åŠ è½½æ—¶çš„åŠ¨ç”»æ•ˆæœ
        window.addEventListener('load', () => {
            document.querySelector('.container').style.opacity = '1';
        });

        // æ¨¡å‹å¸®åŠ©å¼¹çª—ç›¸å…³
        function showModelHelp() {
            document.getElementById('modelHelpModal').style.display = 'block';
        }

        function hideModelHelp() {
            document.getElementById('modelHelpModal').style.display = 'none';
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('modelHelpModal');
            if (event.target === modal) {
                hideModelHelp();
            }
        }
    </script>
</body>
</html>

